---
layout: post
title:  "Deploying a Jekyll site to GitHub Pages with Rake"
date:   2021-12-12 00:00:00
categories: jekyll open-sourcers-chronicle
---

{% newthought 'Deploying to GitHub pages' %} was more complicated than I expected. This was because the jekyll theme used plugins that github pages did not support, so the site had to be deployed by using the static _site folder generated by jekyll <!--more-->when the ```jekyll build``` command is used instead of just pushing the whole project and letting github build it.

## How it works
A Rakefile contains the publish function (can be run via ```rake publish``` on the terminal) which, generates the site; moves the content of _site into a temp directory; checks out a branch called gh-pages; removes all the content in gh-pages; moves the contents of the temp directory into gh-pages; commits and pushes gh-pages; checks out main; prints yolo;
If you use a custom domain for your gh-pages site, you need to have the CNAME file on the main branch and the publish function will move the CNAME file into the temp directory as well ensuring the CNAME file is reput in gh-pages after its contents are deleted. Here is the Rakefile:
``` ruby
require 'rubygems'
require 'rake'
require 'rdoc'
require 'date'
require 'yaml'
require 'tmpdir'
require 'jekyll'

desc "Generate blog files"
task :generate do
  Jekyll::Site.new(Jekyll.configuration({
    "source"      => ".",
    "destination" => "_site"
  })).process
end


desc "Generate and publish blog to gh-pages"
task :publish => [:generate] do
  Dir.mktmpdir do |tmp|
    system "mv _site/* #{tmp}"
    # uncomment if you have a CNAME file
    # system "mv CNAME #{tmp}"
    system "git checkout -B gh-pages"
    system "rm -rf *"
    system "mv #{tmp}/* ."
    message = "Site updated at #{Time.now.utc}"
    system "git add ."
    system "git commit -am #{message.shellescape}"
    system "git push origin gh-pages --force"
    system "git checkout main"
    system "echo yolo"
  end
end

task :default => :publish
```
It should be placed at the highest level in your jekyll projects' directory.

## GitHub Pages settings
After running the above script by typing ```rake publish``` on the terminal, your GitHub Pages setting also need to be configured. Go to your repository, navigate to Settings > Pages. Under the Source section you will be able to set which branch the site is gets built from, set that to be gh-pages.

## Using with a custom domain
You can set-up a custom domain for your site by following the instructions outlined by GitHub in their [GitHub Pages documentation](https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site). After you set a custom domain a CNAME file will be generated for the gh-pages branch, you need to copy that file into the main branch(in the same place where the Rakefile is). In the Rakefile uncomment ```system "mv CNAME #{tmp}"```, by deleting the hashtag and space at the start of the line. This line copies the CNAME file into gh-pages when publish is used. There might be other ways to have the CNAME file in gh-pages but this is the method I use.

The original Rakefile comes from the [tufte-jekyll](https://github.com/clayh53/tufte-jekyll) repository, I modified it to account for the CNAME file and also work with "main" instead of "master".
{% postauthor 'Jason Carvalho' %}
